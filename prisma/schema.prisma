generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
    // directUrl = env("DIRECT_URL")
}

model User {
    id           String   @id @default(cuid())
    username     String   @unique @db.VarChar(100)
    name         String   @db.VarChar(100)
    email        String   @unique @db.VarChar(100)
    password     String?  @db.VarChar(150)
    access_token String?  @db.VarChar(255)
    image        String?
    phone        String?  @db.VarChar(20)
    provider     String
    created_at   DateTime @default(now())
    updated_at   DateTime @updatedAt

    @@map("users")
}

model Customer {
    id                  String            @id @default(cuid())
    name                String            @db.VarChar(50) // nama
    national_id         String            @unique @db.VarChar(20) // NIK
    id_card_address     String            @db.VarChar(100) // alamat KTP
    residential_address String            @db.VarChar(100) // alamat tinggal
    occupation          String            @db.VarChar(100) // pekerjaan
    phone               String            @db.VarChar(20) // nomor telepon
    guarantors          Guarantor[]
    loan_reference      LoanReference?
    credit_worthiness   CreditWorthiness?
    transaction         Transaction?
    created_at          DateTime          @default(now())
    updated_at          DateTime          @updatedAt

    @@map("customers")
}

model Guarantor {
    id                  String   @id @default(cuid())
    name                String   @db.VarChar(50) // nama
    national_id         String   @unique @db.VarChar(20) // NIK
    id_card_address     String   @db.VarChar(100) // alamat KTP
    residential_address String   @db.VarChar(100) // alamat tinggal
    occupation          String   @db.VarChar(100) // pekerjaan
    phone               String   @db.VarChar(20) // nomor telepon
    relationship        String   @db.VarChar(100) // hubungan keluarga
    customer_id         String
    customer            Customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)
    created_at          DateTime @default(now())
    updated_at          DateTime @updatedAt

    @@map("guarantors")
}

model LoanReference {
    id                      String            @id @default(cuid())
    monthly_income          String            @db.VarChar(100) // pendapatan bulanan
    monthly_expenses        String            @db.VarChar(100) // pengeluaran bulanan
    monthly_surplus         String            @db.VarChar(100)
    employment_status       Boolean // status pekerjaan tetap/tidak tetap
    previous_credit_history Boolean // riwayat kredit sebelumnya
    requested_loan_amount   String            @db.VarChar(100) // jumlah pinjaman yang diajukan
    collateral_estimate     String            @db.VarChar(100) // taksiran jaminan
    loan_term               Int // jangka waktu pinjaman (bulan)
    installment             String            @db.VarChar(100) // angsuran setiap bulan dengan bunga
    customer_id             String            @unique
    customer                Customer          @relation(fields: [customer_id], references: [id], onDelete: Cascade)
    credit_worthiness       CreditWorthiness?
    created_at              DateTime          @default(now())
    updated_at              DateTime          @updatedAt

    @@map("loan_references")
}

model CreditWorthiness {
    id                String        @id @default(cuid())
    status            Boolean
    customer_id       String        @unique
    loan_reference_id String        @unique
    customer          Customer      @relation(fields: [customer_id], references: [id], onDelete: Cascade)
    loan_reference    LoanReference @relation(fields: [loan_reference_id], references: [id], onDelete: Cascade)
    created_at        DateTime      @default(now())
    updated_at        DateTime      @updatedAt

    @@map("credit_worthinesses")
}

model Transaction {
    id                   String            @id @default(cuid())
    loan_installment     String            @db.VarChar(100) // angsuran setiap pinjaman bulan 
    interest_installment String            @db.VarChar(100) // angsuran setiap bunga bulan 
    total_installment    String            @db.VarChar(100) // angsuran setiap bulan dengan bunga
    loan_term            Int // jangka waktu pinjaman (bulan)
    loan_amount          String            @db.VarChar(100)
    interest_amount      String            @db.VarChar(100)
    total_amount         String            @db.VarChar(100)
    transaction_status   TransactionStatus @default(ACTIVE)
    end_transaction      DateTime
    customer_id          String            @unique
    customer             Customer          @relation(fields: [customer_id], references: [id], onDelete: Restrict)
    payment_records      PaymentRecord[] // Relasi ke catatan pembayaran
    LoanBalance          LoanBalance?
    created_at           DateTime          @default(now())
    updated_at           DateTime          @updatedAt

    @@map("transactions")
}

model LoanBalance {
    id                     String      @id @default(cuid())
    remaining_loan_amount  String      @db.VarChar(100) // jumlah sisa pinjaman yang harus dibayar
    remaining_total_amount String      @db.VarChar(100) // jumlah sisa pinjaman yang harus dibayar
    interest_due           String      @db.VarChar(100) // jumlah sisa bunga yang harus dibayar
    total_paid             String      @db.VarChar(100) // total jumlah yang sudah dibayar
    last_payment_date      DateTime? // tanggal pembayaran terakhir
    next_due_date          DateTime // tanggal jatuh tempo pembayaran berikutnya
    transaction_id         String      @unique // relasi one-to-one dengan transaksi
    transaction            Transaction @relation(fields: [transaction_id], references: [id], onDelete: Restrict)
    created_at             DateTime    @default(now()) // waktu pembuatan record
    updated_at             DateTime    @updatedAt // waktu terakhir record diupdate

    @@map("loan_balances")
}

model PaymentRecord {
    id               String          @id @default(cuid())
    payment_date     DateTime?
    due_date         DateTime // tanggal jatuh tempo
    amount_paid      String          @db.VarChar(100) // jumlah yang dibayar
    payment_status   PaymentStatus   @default(PENDING) // status pembayaran
    payment_month    Int // bulan ke-berapa dari cicilan (1-n)
    transaction_id   String // referensi ke transaksi
    transaction      Transaction     @relation(fields: [transaction_id], references: [id], onDelete: Cascade)
    payment_category PaymentCategory
    payment_method   PaymentMethod   @default(CASH) // metode pembayaran
    notes            String?         @db.Text // catatan tambahan
    created_at       DateTime        @default(now())
    updated_at       DateTime        @updatedAt

    @@map("payment_records")
}

enum TransactionStatus {
    ACTIVE // Pinjaman aktif/sedang berjalan
    PAID // Pinjaman sudah lunas
    CANCELED //Pinjaman dibatalkan
    OVERDUE //Pinjaman lewat jatuh tempo
}

enum PaymentStatus {
    PENDING // menunggu pembayaran
    PAID // sudah dibayar
}

enum PaymentMethod {
    CASH // menunggu pembayaran
}

enum PaymentCategory {
    LOAN
    INTEREST
    TOTAL
}
